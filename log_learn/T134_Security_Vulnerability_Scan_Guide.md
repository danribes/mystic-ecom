# T134: Security Vulnerability Scanner - Learning Guide

**Topic**: Complete guide to security vulnerability scanning for Node.js applications
**Audience**: Developers, DevOps engineers, security professionals
**Prerequisites**: Basic understanding of Node.js, npm, and dependency management

---

## Table of Contents
1. [Introduction to Security Vulnerability Scanning](#introduction-to-security-vulnerability-scanning)
2. [Understanding npm Audit](#understanding-npm-audit)
3. [Vulnerability Severity Levels](#vulnerability-severity-levels)
4. [Common Vulnerability Types](#common-vulnerability-types)
5. [The Security Scanner Implementation](#the-security-scanner-implementation)
6. [How to Use the Scanner](#how-to-use-the-scanner)
7. [Configuring Thresholds](#configuring-thresholds)
8. [Interpreting Scan Results](#interpreting-scan-results)
9. [Remediation Strategies](#remediation-strategies)
10. [CI/CD Integration](#cicd-integration)
11. [Best Practices](#best-practices)
12. [Troubleshooting](#troubleshooting)

---

## Introduction to Security Vulnerability Scanning

### What is Security Vulnerability Scanning?

Security vulnerability scanning is the automated process of examining software dependencies for known security vulnerabilities. For Node.js applications, this means checking npm packages (and their transitive dependencies) against databases of known security issues.

### Why is it Important?

**Statistics**:
- 80-90% of application code comes from third-party dependencies
- Average Node.js project has 100-1000+ dependencies
- New vulnerabilities discovered daily

**Risks**:
- **Data Breaches**: Attackers exploit known vulnerabilities
- **Supply Chain Attacks**: Compromised dependencies
- **Compliance Violations**: Regulatory requirements (PCI-DSS, HIPAA, SOC 2)
- **Reputation Damage**: Security incidents harm trust
- **Financial Loss**: Breach costs, legal fees, fines

**Benefits of Regular Scanning**:
- Early vulnerability detection
- Automated security monitoring
- Compliance demonstration
- Risk reduction
- Developer awareness

### How Does it Work?

```
Your Application
    ‚îú‚îÄ‚îÄ package.json (direct dependencies)
    ‚îî‚îÄ‚îÄ node_modules/
        ‚îú‚îÄ‚îÄ dependency-a
        ‚îÇ   ‚îî‚îÄ‚îÄ node_modules/ (transitive dependencies)
        ‚îú‚îÄ‚îÄ dependency-b
        ‚îî‚îÄ‚îÄ dependency-c

        ‚Üì Scan Process ‚Üì

npm audit ‚Üí Checks against vulnerability database
           ‚Üì
    Identifies known vulnerabilities
           ‚Üì
    Generates report with:
    - Severity levels
    - CVE identifiers
    - Affected versions
    - Fix recommendations
```

---

## Understanding npm Audit

### What is npm Audit?

`npm audit` is a built-in npm command that:
1. Analyzes your `package-lock.json` or `npm-shrinkwrap.json`
2. Compares dependencies against npm's security advisory database
3. Returns vulnerabilities with severity ratings
4. Suggests fixes when available

### How npm Audit Works

**Data Sources**:
- **GitHub Advisory Database**: Primary source
- **CVE Database**: Common Vulnerabilities and Exposures
- **npm Security Team**: Manual curation
- **Security Researchers**: Community submissions

**Audit Process**:
```typescript
// 1. Read dependency tree
const dependencyTree = parseLockFile('package-lock.json');

// 2. For each package version:
for (const pkg of dependencyTree) {
  // 3. Query vulnerability database
  const vulnerabilities = queryAdvisoryDB(pkg.name, pkg.version);

  // 4. Check if version affected
  if (vulnerabilities.length > 0) {
    // 5. Calculate fix path
    const fix = calculateFix(pkg, vulnerabilities);

    // 6. Add to report
    report.add({
      package: pkg,
      vulnerabilities,
      fix
    });
  }
}
```

### npm Audit Output Format

**Version 2 Format** (current):
```json
{
  "auditReportVersion": 2,
  "vulnerabilities": {
    "package-name": {
      "name": "package-name",
      "severity": "high",
      "isDirect": false,
      "range": "<1.2.3",
      "via": [
        {
          "source": 1109208,
          "name": "package-name",
          "dependency": "package-name",
          "title": "Vulnerability description",
          "url": "https://github.com/advisories/GHSA-xxxx",
          "severity": "high",
          "cwe": ["CWE-79"],
          "cvss": {
            "score": 7.5,
            "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N"
          },
          "range": "<1.2.3"
        }
      ],
      "effects": ["dependent-package"],
      "fixAvailable": {
        "name": "parent-package",
        "version": "2.0.0",
        "isSemVerMajor": true
      },
      "nodes": ["node_modules/path/to/package"]
    }
  },
  "metadata": {
    "vulnerabilities": {
      "info": 0,
      "low": 1,
      "moderate": 3,
      "high": 2,
      "critical": 0,
      "total": 6
    },
    "dependencies": {
      "prod": 150,
      "dev": 80,
      "optional": 10,
      "peer": 5,
      "peerOptional": 0,
      "total": 245
    }
  }
}
```

### npm Audit Commands

```bash
# Basic audit
npm audit

# Get JSON output
npm audit --json

# Audit only production dependencies
npm audit --production

# Audit with fix suggestions
npm audit fix

# Audit and fix breaking changes (caution!)
npm audit fix --force

# Dry run (preview fixes)
npm audit fix --dry-run
```

---

## Vulnerability Severity Levels

### CVSS (Common Vulnerability Scoring System)

Vulnerabilities are rated using CVSS v3.1, which considers:
- **Attack Vector**: How the vulnerability is exploited (Network, Adjacent, Local, Physical)
- **Attack Complexity**: How difficult to exploit (Low, High)
- **Privileges Required**: What access needed (None, Low, High)
- **User Interaction**: User action required (None, Required)
- **Scope**: Impact beyond vulnerable component (Unchanged, Changed)
- **Confidentiality Impact**: Data disclosure risk (None, Low, High)
- **Integrity Impact**: Data modification risk (None, Low, High)
- **Availability Impact**: Service disruption risk (None, Low, High)

### Severity Ratings

| Severity | CVSS Score | Risk Level | Response Time |
|----------|-----------|------------|---------------|
| **Critical** | 9.0 - 10.0 | Extreme | Immediate (hours) |
| **High** | 7.0 - 8.9 | Significant | Urgent (days) |
| **Moderate** | 4.0 - 6.9 | Medium | Important (weeks) |
| **Low** | 0.1 - 3.9 | Minor | Normal (months) |
| **Info** | 0.0 | Informational | Optional |

### Severity Examples

#### Critical (9.0-10.0)

**Example**: Remote Code Execution (RCE)
```javascript
// Vulnerable code
eval(userInput); // User input executed as code

// Attack
userInput = "process.exit()"; // Can shut down server
userInput = "require('fs').readFileSync('/etc/passwd')"; // Can read sensitive files
```

**Impact**:
- Complete system compromise
- Data theft
- Service disruption
- Lateral movement

#### High (7.0-8.9)

**Example**: SQL Injection
```javascript
// Vulnerable code
const query = `SELECT * FROM users WHERE id = ${userId}`;

// Attack
userId = "1 OR 1=1"; // Returns all users
userId = "1; DROP TABLE users; --"; // Deletes table
```

**Impact**:
- Data breach
- Data manipulation
- Authentication bypass

#### Moderate (4.0-6.9)

**Example**: Cross-Site Scripting (XSS)
```javascript
// Vulnerable code
element.innerHTML = userComment; // Unsanitized user input

// Attack
userComment = "<script>sendCookies(document.cookie)</script>";
```

**Impact**:
- Session hijacking
- Phishing
- Content injection

#### Low (0.1-3.9)

**Example**: Information Disclosure
```javascript
// Verbose error messages
catch (error) {
  res.status(500).send(error.stack); // Exposes internal paths
}
```

**Impact**:
- Information leakage
- Reconnaissance aid
- Minor privacy concerns

---

## Common Vulnerability Types

### 1. Prototype Pollution

**What It Is**: Attacker modifies JavaScript object prototype

**Example**:
```javascript
// Vulnerable lodash merge
const _ = require('lodash');

const userInput = JSON.parse('{"__proto__": {"isAdmin": true}}');
_.merge({}, userInput);

// Now all objects have isAdmin: true
console.log({}.isAdmin); // true (polluted!)
```

**Impact**: Privilege escalation, DoS, RCE

**CVE Examples**: CVE-2019-10744 (lodash)

### 2. Command Injection

**What It Is**: User input executed as system commands

**Example**:
```javascript
// Vulnerable
const { exec } = require('child_process');
exec(`ping -c 4 ${req.query.host}`);

// Attack
// ?host=example.com; cat /etc/passwd
```

**Impact**: System compromise, data theft

**CVE Examples**: CVE-2020-7699 (node-cmd)

### 3. Path Traversal

**What It Is**: Access files outside intended directory

**Example**:
```javascript
// Vulnerable
app.get('/file', (req, res) => {
  const file = path.join(__dirname, 'public', req.query.name);
  res.sendFile(file);
});

// Attack
// /file?name=../../etc/passwd
```

**Impact**: Sensitive file access

**CVE Examples**: CVE-2020-7788 (serve)

### 4. Regular Expression Denial of Service (ReDoS)

**What It Is**: Regex causes exponential backtracking

**Example**:
```javascript
// Vulnerable regex
const regex = /^(a+)+$/;
regex.test('aaaaaaaaaaaaaaaaaaaaaaaX'); // Hangs server

// Attack: Send crafted input to cause DoS
```

**Impact**: Service disruption

**CVE Examples**: CVE-2020-7661 (validator.js)

### 5. Cross-Site Scripting (XSS)

**What It Is**: Injected scripts execute in victim's browser

**Example**:
```javascript
// Vulnerable
app.get('/search', (req, res) => {
  res.send(`<h1>Results for: ${req.query.q}</h1>`);
});

// Attack
// /search?q=<script>alert(document.cookie)</script>
```

**Impact**: Session hijacking, data theft

### 6. Insecure Deserialization

**What It Is**: Untrusted data deserialized causing RCE

**Example**:
```javascript
// Vulnerable node-serialize
const serialize = require('node-serialize');
const obj = serialize.unserialize(userInput);

// Attack
userInput = '{"rce":"_$$ND_FUNC$$_function(){require(\'child_process\').exec(\'whoami\')}()"}';
```

**Impact**: Remote code execution

**CVE Examples**: CVE-2017-5941 (node-serialize)

---

## The Security Scanner Implementation

### Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          VulnerabilityScanner Class              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  runNpmAudit()                                  ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> Execute: npm audit --json               ‚îÇ
‚îÇ    ‚îú‚îÄ> Parse JSON output                       ‚îÇ
‚îÇ    ‚îî‚îÄ> Return NpmAuditReport                   ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  analyzeAuditReport(report)                    ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> Extract vulnerabilities                 ‚îÇ
‚îÇ    ‚îú‚îÄ> Sort by severity                        ‚îÇ
‚îÇ    ‚îú‚îÄ> Count fixable vs breaking              ‚îÇ
‚îÇ    ‚îú‚îÄ> Generate recommendations                ‚îÇ
‚îÇ    ‚îî‚îÄ> Return SecurityScanResult               ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  checkThreshold(summary)                       ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> Check maxVulnerabilities               ‚îÇ
‚îÇ    ‚îú‚îÄ> Check failOnSeverity                   ‚îÇ
‚îÇ    ‚îî‚îÄ> Return boolean                          ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  generateMarkdownReport(result)                ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> Format summary table                    ‚îÇ
‚îÇ    ‚îú‚îÄ> List recommendations                    ‚îÇ
‚îÇ    ‚îú‚îÄ> Detail vulnerabilities                  ‚îÇ
‚îÇ    ‚îî‚îÄ> Return markdown string                  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  saveReport(result)                            ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> Create output directory                 ‚îÇ
‚îÇ    ‚îú‚îÄ> Save JSON report                        ‚îÇ
‚îÇ    ‚îú‚îÄ> Save Markdown report                    ‚îÇ
‚îÇ    ‚îî‚îÄ> Return file path                        ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  scan()                                         ‚îÇ
‚îÇ    ‚îÇ                                            ‚îÇ
‚îÇ    ‚îú‚îÄ> runNpmAudit()                          ‚îÇ
‚îÇ    ‚îú‚îÄ> analyzeAuditReport()                   ‚îÇ
‚îÇ    ‚îú‚îÄ> saveReport() (if configured)           ‚îÇ
‚îÇ    ‚îî‚îÄ> Return SecurityScanResult               ‚îÇ
‚îÇ                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   CLI Interface       ‚îÇ
         ‚îÇ  (securityScan.ts)    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îú‚îÄ> Parse arguments
                     ‚îú‚îÄ> Create scanner
                     ‚îú‚îÄ> Run scan
                     ‚îú‚îÄ> Format output
                     ‚îî‚îÄ> Exit with code
```

### Key Components

#### 1. VulnerabilityScanner Class

**Purpose**: Core scanning engine

**Responsibilities**:
- Execute npm audit
- Parse and analyze results
- Apply threshold rules
- Generate reports
- Provide recommendations

**Usage**:
```typescript
import { VulnerabilityScanner } from './src/lib/security/vulnerabilityScanner';

const scanner = new VulnerabilityScanner({
  failOnSeverity: ['critical', 'high'],
  saveReport: true
});

const result = await scanner.scan();
```

#### 2. CLI Interface

**Purpose**: Command-line tool for scanning

**Responsibilities**:
- Parse CLI arguments
- Display formatted output
- Return appropriate exit codes
- Save reports to disk

**Usage**:
```bash
npm run security:scan
npm run security:scan:save
npm run security:scan:ci
```

#### 3. Report Generator

**Purpose**: Create human and machine-readable reports

**Formats**:
- JSON (machine-readable, for automation)
- Markdown (human-readable, for documentation)

**Output**:
```
security-reports/
‚îú‚îÄ‚îÄ latest-security-report.md
‚îî‚îÄ‚îÄ security-scan-2025-11-05T20-17-49.json
```

---

## How to Use the Scanner

### Basic Usage

**1. Quick Scan**:
```bash
npm run security:scan
```

Output:
```
üîç Running Security Vulnerability Scan...

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä SCAN SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Scan Date: 11/5/2025, 9:17:49 PM
Status: ‚úÖ PASSED

Vulnerabilities by Severity:
  Critical:  0
  High:      0
  Moderate:  2
  Low:       1
  Info:      0
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total:     3

Fixable:               2
Requires Manual Review: 1

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí° RECOMMENDATIONS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

  ‚úÖ 2 vulnerabilities can be fixed automatically with 'npm audit fix'
  ‚öôÔ∏è  1 vulnerabilities require breaking changes. Review with 'npm audit fix --force'
  üìö Review vulnerability details and plan remediation strategy
  üîÑ Regularly run security scans to catch new vulnerabilities

‚úÖ Security scan PASSED - no critical issues found
```

**2. Scan with Report**:
```bash
npm run security:scan:save
```

Generates:
- `security-reports/latest-security-report.md`
- `security-reports/security-scan-{timestamp}.json`

**3. CI/CD Scan**:
```bash
npm run security:scan:ci
```

- Fails on critical or high severity
- Saves reports for artifacts
- Returns exit code 1 on failure

### Advanced Usage

**Custom Thresholds**:
```bash
npx tsx src/scripts/securityScan.ts \
  --max-critical 0 \
  --max-high 2 \
  --max-moderate 10 \
  --save-report
```

**Exclude Packages**:
```bash
npx tsx src/scripts/securityScan.ts \
  --exclude lodash,express \
  --fail-on critical
```

**Programmatic Usage**:
```typescript
import { VulnerabilityScanner } from './src/lib/security/vulnerabilityScanner';

async function customScan() {
  const scanner = new VulnerabilityScanner({
    failOnSeverity: ['critical'],
    maxVulnerabilities: {
      high: 5,
      moderate: 20
    },
    saveReport: true,
    outputDir: './custom-reports'
  });

  const result = await scanner.scan();

  if (result.summary.critical > 0) {
    await notifySecurityTeam(result);
  }

  return result;
}
```

### CLI Options Reference

| Option | Short | Description | Example |
|--------|-------|-------------|---------|
| `--help` | `-h` | Show help message | `--help` |
| `--save-report` | `-s` | Save reports to disk | `--save-report` |
| `--output-dir` | `-o` | Output directory | `--output-dir ./reports` |
| `--fail-on` | `-f` | Fail on severities | `--fail-on critical,high` |
| `--max-critical` | - | Max critical vulns | `--max-critical 0` |
| `--max-high` | - | Max high vulns | `--max-high 5` |
| `--max-moderate` | - | Max moderate vulns | `--max-moderate 20` |
| `--max-low` | - | Max low vulns | `--max-low 50` |
| `--snyk` | - | Enable Snyk | `--snyk` |
| `--snyk-token` | - | Snyk API token | `--snyk-token TOKEN` |
| `--exclude` | `-e` | Exclude packages | `--exclude pkg1,pkg2` |

---

## Configuring Thresholds

### Understanding Thresholds

Thresholds determine when a scan "passes" or "fails". This is crucial for:
- **CI/CD gates**: Prevent deployment of vulnerable code
- **Development workflows**: Balance security vs development speed
- **Compliance**: Meet regulatory requirements

### Threshold Types

**1. Severity-Based** (failOnSeverity):
```typescript
{
  failOnSeverity: ['critical', 'high']
}
```
- Fails if ANY vulnerabilities of specified severities found
- Use for strict security requirements
- Recommended for production deployments

**2. Count-Based** (maxVulnerabilities):
```typescript
{
  maxVulnerabilities: {
    critical: 0,
    high: 2,
    moderate: 10,
    low: 20
  }
}
```
- Fails if count exceeds threshold
- Use for gradual improvement
- Recommended for legacy projects

### Environment-Specific Configurations

**Development Environment**:
```typescript
{
  maxVulnerabilities: {
    critical: 2,
    high: 10,
    moderate: 50,
    low: 100
  },
  saveReport: false
}
```
- Permissive thresholds
- Allow some vulnerabilities
- Fast feedback loop

**Staging Environment**:
```typescript
{
  maxVulnerabilities: {
    critical: 0,
    high: 2,
    moderate: 10
  },
  saveReport: true,
  outputDir: './staging-reports'
}
```
- Stricter than development
- Track trends
- Pre-production validation

**Production Environment**:
```typescript
{
  failOnSeverity: ['critical', 'high'],
  maxVulnerabilities: {
    critical: 0,
    high: 0
  },
  saveReport: true,
  outputDir: '/var/log/security'
}
```
- Zero tolerance for critical/high
- Strict enforcement
- Compliance documentation

**CI/CD Pipeline**:
```typescript
{
  failOnSeverity: ['critical', 'high'],
  saveReport: true,
  outputDir: './artifacts/security'
}
```
- Fail builds on critical/high
- Save reports as artifacts
- Automatic enforcement

### Threshold Strategies

**1. Zero Tolerance** (Strict):
```typescript
{
  failOnSeverity: ['critical', 'high', 'moderate']
}
```
‚úÖ Maximum security
‚ùå May block development
üéØ Use for: Critical infrastructure, healthcare, finance

**2. Progressive Improvement** (Gradual):
```typescript
{
  maxVulnerabilities: {
    critical: 0,
    high: currentHigh, // Current count
    moderate: currentModerate
  }
}
```
‚úÖ Allows gradual fixes
‚úÖ Prevents regression
üéØ Use for: Legacy projects, technical debt

**3. Risk-Based** (Balanced):
```typescript
{
  failOnSeverity: ['critical'],
  maxVulnerabilities: {
    high: 5,
    moderate: 20
  }
}
```
‚úÖ Balance security and velocity
‚úÖ Focus on critical issues
üéØ Use for: Most projects

---

## Interpreting Scan Results

### Understanding the Report

**1. Status**:
- ‚úÖ **PASSED**: Within acceptable thresholds
- ‚ùå **FAILED**: Exceeded thresholds

**2. Summary Statistics**:
```
Vulnerabilities by Severity:
  Critical:  0
  High:      4
  Moderate:  0
  Low:       0
  Total:     4

Fixable:               0
Requires Manual Review: 4
```

**Key Metrics**:
- **Total**: All vulnerabilities found
- **By Severity**: Breakdown by risk level
- **Fixable**: Can fix with `npm audit fix`
- **Manual Review**: Require `npm audit fix --force` or manual updates

**3. Recommendations**:

Example:
```
üí° RECOMMENDATIONS

‚ö†Ô∏è  HIGH: Found 4 high-severity vulnerabilities. Prioritize fixing these.
üì¶ 1 vulnerabilities in direct dependencies. Update these packages first.
‚öôÔ∏è  4 vulnerabilities require breaking changes. Review with 'npm audit fix --force'
üîç Consider enabling Snyk for advanced security scanning and monitoring
üìö Review vulnerability details and plan remediation strategy
üîÑ Regularly run security scans to catch new vulnerabilities
```

**Action Items**:
- üö® **Immediate**: Critical vulnerabilities
- ‚ö†Ô∏è **Urgent**: High-severity vulnerabilities
- üì¶ **Priority**: Direct dependencies
- ‚úÖ **Easy Wins**: Auto-fixable vulnerabilities

**4. Vulnerability Details**:

```markdown
### 1. playwright

**Severity**: HIGH
**Title**: Playwright downloads and installs browsers without verifying SSL certificate
**CVSS Score**: 7.5
**CWE**: CWE-347
**Direct Dependency**: No
**Affected Versions**: <1.55.1
**Fix Available**: Yes (1.7.9)
‚ö†Ô∏è  *Requires breaking change*
**More Info**: https://github.com/advisories/GHSA-7mvr-c777-76hp
```

**What to Look For**:
- **Severity**: How serious?
- **Direct Dependency**: Can you update directly?
- **Fix Available**: Is there a solution?
- **Breaking Change**: Will it affect your code?
- **CVSS/CWE**: Technical details for assessment

### Common Scenarios

**Scenario 1: Clean Scan**
```
Status: ‚úÖ PASSED
Total: 0
```
‚ú® Great job! Continue regular scanning.

**Scenario 2: Fixable Vulnerabilities**
```
Status: ‚ùå FAILED
High: 3
Fixable: 3
```
üëâ Action: Run `npm audit fix`

**Scenario 3: Breaking Changes Required**
```
Status: ‚ùå FAILED
Critical: 1
Requires Manual Review: 1
```
üëâ Action: Review fix, test thoroughly, apply `npm audit fix --force`

**Scenario 4: Transitive Dependency**
```
playwright (transitive via artillery)
Fix: Requires artillery@1.7.9 (breaking)
```
üëâ Action: Wait for parent package update or find alternative

**Scenario 5: No Fix Available**
```
Status: ‚ùå FAILED
High: 1
Fix Available: No
```
üëâ Action: Monitor for updates, consider alternatives, document risk acceptance

---

## Remediation Strategies

### 1. Automated Fixes

**When**: Fix available, no breaking changes

**Command**:
```bash
npm audit fix
```

**What It Does**:
- Updates packages to nearest safe version
- Within semver range (^1.0.0 ‚Üí ^1.2.3)
- No breaking changes
- Safe for automated application

**Example**:
```json
// Before
"lodash": "^4.17.19"

// After npm audit fix
"lodash": "^4.17.21"
```

### 2. Force Fixes

**When**: Breaking changes required

**Command**:
```bash
npm audit fix --force
```

**What It Does**:
- Updates to latest safe version
- May introduce breaking changes
- Requires testing

**Process**:
1. **Backup**: Commit current code
2. **Apply**: Run `npm audit fix --force`
3. **Test**: Run all tests
4. **Review**: Check for breaking changes
5. **Fix**: Update your code if needed
6. **Commit**: Save working changes

**Example**:
```json
// Before
"artillery": "^2.0.0"

// After npm audit fix --force
"artillery": "^1.7.9" // Downgrade to fix
```

### 3. Manual Updates

**When**: Transitive dependencies, no auto-fix

**Process**:
1. **Identify Root**: Find which direct dependency pulls in vulnerable package
2. **Check Updates**: See if parent package has updates
3. **Update Parent**: `npm update parent-package`
4. **Test**: Verify fix applied

**Example**:
```
playwright (vulnerability)
  ‚Üë via artillery-engine-playwright
  ‚Üë via artillery (your direct dependency)

Solution: Update artillery
npm update artillery
```

### 4. Alternative Packages

**When**: No fix available, high severity

**Process**:
1. **Research**: Find maintained alternatives
2. **Evaluate**: Check features, performance, community
3. **Test**: Implement in feature branch
4. **Migrate**: Gradually replace
5. **Monitor**: Track new package security

**Example**:
```javascript
// Before (vulnerable)
const moment = require('moment');

// After (secure alternative)
const { DateTime } = require('luxon');
```

### 5. Risk Acceptance

**When**: Low impact, no fix available, mitigated

**Process**:
1. **Assess Impact**: Does vulnerability affect your use case?
2. **Check Exploitability**: Is there a known exploit?
3. **Review Mitigations**: Can you mitigate in other ways?
4. **Document**: Create risk acceptance record
5. **Monitor**: Track for future fixes

**Risk Acceptance Template**:
```markdown
## Security Risk Acceptance

**Vulnerability**: CVE-2021-1234
**Package**: example-package@1.0.0
**Severity**: Moderate
**Assessor**: [Name]
**Date**: 2025-11-05

### Impact Assessment
- Vulnerability: Prototype pollution
- Our Usage: We only use for data transformation, no user input
- Attack Vector: Requires user-controlled input, which we don't have
- CVSS Score: 5.3 (Moderate)

### Mitigations
- Input validation at API boundary
- WAF rules block common exploits
- Monitoring for anomalous behavior

### Decision
ACCEPTED: Low risk due to controlled environment and mitigations.

### Review Date
2025-12-05 (monthly review)
```

### 6. Workarounds

**When**: Fix not yet available, temporary solution needed

**Examples**:

**A. Package Overrides** (npm >=8.3.0):
```json
{
  "overrides": {
    "vulnerable-package": "^safe-version"
  }
}
```

**B. Patch Files**:
```bash
# Install patch-package
npm install --save-dev patch-package

# Make changes to node_modules/vulnerable-package
# ...

# Generate patch
npx patch-package vulnerable-package

# Adds patch to patches/ directory
# Applied automatically on npm install
```

**C. Input Validation**:
```javascript
// Vulnerable to ReDoS
const vulnerable = /^(a+)+$/;

// Add input validation
function safeValidate(input) {
  if (input.length > 100) {
    return false; // Prevent ReDoS
  }
  return vulnerable.test(input);
}
```

---

## CI/CD Integration

### GitHub Actions

**Complete Example**:
```yaml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security scan
        id: scan
        run: |
          npm run security:scan:ci
        continue-on-error: true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync(
              './security-reports/latest-security-report.md',
              'utf8'
            );

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîí Security Scan Results\n\n${report}`
            });

      - name: Fail if vulnerabilities found
        if: steps.scan.outcome == 'failure'
        run: exit 1
```

### GitLab CI

```yaml
security-scan:
  stage: security
  image: node:20-alpine
  script:
    - npm ci
    - npm run security:scan:ci
  artifacts:
    when: always
    paths:
      - security-reports/
    expire_in: 30 days
    reports:
      junit: security-reports/security-scan.xml
  only:
    - merge_requests
    - main
  allow_failure: false

security-scan-scheduled:
  extends: security-scan
  only:
    - schedules
  allow_failure: true
```

### CircleCI

```yaml
version: 2.1

jobs:
  security-scan:
    docker:
      - image: node:20
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
      - run: npm ci
      - run:
          name: Run security scan
          command: npm run security:scan:ci
      - store_artifacts:
          path: security-reports/
          destination: security-reports
      - store_test_results:
          path: security-reports/

workflows:
  version: 2
  security:
    jobs:
      - security-scan:
          filters:
            branches:
              only:
                - main
                - develop
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only: main
```

### Jenkins

```groovy
pipeline {
    agent any

    stages {
        stage('Install') {
            steps {
                sh 'npm ci'
            }
        }

        stage('Security Scan') {
            steps {
                script {
                    try {
                        sh 'npm run security:scan:ci'
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        throw e
                    } finally {
                        archiveArtifacts artifacts: 'security-reports/**/*',
                                       allowEmptyArchive: true
                        publishHTML([
                            reportDir: 'security-reports',
                            reportFiles: 'latest-security-report.md',
                            reportName: 'Security Scan Report'
                        ])
                    }
                }
            }
        }
    }

    triggers {
        cron('H 2 * * *') // Daily at ~2 AM
    }
}
```

---

## Best Practices

### 1. Scan Frequency

**Development**:
- Run before committing: `pre-commit hook`
- Run on save (IDE integration)

**CI/CD**:
- Every pull request
- Every merge to main
- Nightly builds
- Before deployments

**Production**:
- Weekly scheduled scans
- After dependency updates
- After security advisories

### 2. Dependency Management

**Regular Updates**:
```bash
# Check outdated packages
npm outdated

# Update to latest within semver
npm update

# Update to latest major versions
npm install package@latest
```

**Lock File Management**:
- Commit `package-lock.json`
- Never manually edit
- Regenerate if corrupted: `rm package-lock.json && npm install`

**Minimal Dependencies**:
- Review before adding
- Consider package size
- Check maintenance status
- Evaluate alternatives

### 3. Security Culture

**Developer Training**:
- Security awareness
- Vulnerability types
- Secure coding practices
- Incident response

**Code Review**:
- Review dependencies in PRs
- Question new package additions
- Verify security fixes

**Documentation**:
- Security policies
- Risk acceptance records
- Incident playbooks
- Dependency guidelines

### 4. Monitoring

**Automated Alerts**:
- Email on critical vulnerabilities
- Slack notifications for failures
- PagerDuty for production issues

**Dashboards**:
- Track vulnerability trends
- Monitor fix rates
- Identify patterns

**Metrics**:
- Mean time to detect (MTTD)
- Mean time to resolve (MTTR)
- Vulnerability density (vulns/KLOC)
- Fix coverage rate

### 5. Compliance

**Standards**:
- PCI-DSS: Regular vulnerability scanning
- HIPAA: Security risk analysis
- SOC 2: Continuous monitoring
- ISO 27001: Information security management

**Documentation**:
- Scan reports
- Risk assessments
- Remediation records
- Audit trails

**Reporting**:
- Executive summaries
- Compliance dashboards
- Audit evidence

---

## Troubleshooting

### Common Issues

**1. "npm audit not found"**
```bash
# Solution: Update npm
npm install -g npm@latest
```

**2. "Invalid API Key" (Snyk)**
```bash
# Solution: Set token
export SNYK_TOKEN=your-token-here
```

**3. "Permission denied" (Reports)**
```bash
# Solution: Check directory permissions
chmod 755 security-reports/
```

**4. "Timeout" (Large projects)**
```typescript
// Solution: Increase buffer
{
  maxBuffer: 50 * 1024 * 1024 // 50MB
}
```

**5. "False positives"**
```typescript
// Solution: Exclude packages
{
  excludePackages: ['false-positive-package']
}
```

### Debug Mode

```bash
# Enable verbose logging
DEBUG=security:* npm run security:scan

# Check npm audit directly
npm audit --json > debug-audit.json
```

---

## Summary

### Key Takeaways

1. **Security scanning is essential** for modern applications
2. **Automate everything**: CI/CD integration, scheduled scans
3. **Act quickly**: Fix critical/high vulnerabilities immediately
4. **Balance security and velocity**: Use appropriate thresholds
5. **Monitor continuously**: New vulnerabilities emerge daily
6. **Document decisions**: Risk acceptance, remediation plans
7. **Foster security culture**: Train team, code reviews
8. **Stay informed**: Subscribe to security advisories

### Next Steps

1. **Immediate**:
   - Run `npm run security:scan`
   - Fix critical vulnerabilities
   - Integrate into CI/CD

2. **Short-term** (This week):
   - Configure thresholds
   - Document security policy
   - Train team on scanner usage

3. **Long-term** (This month):
   - Set up automated monitoring
   - Establish remediation SLAs
   - Create security dashboard

### Resources

- **npm audit docs**: https://docs.npmjs.com/cli/v8/commands/npm-audit
- **Snyk**: https://snyk.io/
- **OWASP**: https://owasp.org/
- **CVE Database**: https://cve.mitre.org/
- **GitHub Advisories**: https://github.com/advisories
- **NIST NVD**: https://nvd.nist.gov/

---

**Remember**: Security is not a one-time task, but an ongoing process. Stay vigilant, keep dependencies updated, and scan regularly!
